# STM32F4 FreeRTOS + CAN Loopback (HAL)

Простой проект на **STM32F407VG-DISC1**, демонстрирующий работу **шины CAN2**  
в режиме **Loopback** под управлением **FreeRTOS**.

Проект создан для изучения базовой настройки CAN-периферии,  
синхронизации задач и диагностики работы CAN-контроллера в RTOS-среде.

---

## ⚙️ Платформа и инструменты

- **Микроконтроллер:** STM32F407VG (Discovery Board)  
- **IDE:** PlatformIO + VS Code  
- **Библиотеки:** STM32 HAL (CubeF4), FreeRTOS  
- **Отладка:** ST-Link (встроенный на плате)  
- **Язык:** C (GCC)

---

## 📘 Описание проекта

Проект выполняет следующие задачи:

1. **Настройка CAN2** в режиме `CAN_MODE_LOOPBACK` на скорости **500 кбит/с**.  
2. **Создание FreeRTOS-задач**, управляющих обменом по CAN и индикацией.  
3. **Проверка успешности инициализации**:
   - Если CAN2 не запустился → мигает **красный LED (PD14)**.  
   - Если всё успешно → циклически передаются и принимаются тестовые кадры.  
4. **Выполнение обмена "сам с собой" (Loopback)** —  
   кадр отправляется через `HAL_CAN_AddTxMessage()` и принимается обратно через FIFO0,  
   подтверждая корректность бит-таймингов и фильтрации.

---

## 📂 Структура проекта

stm32f4-freertos-can-loopback/
├── src/
│   ├── main.c              # Точка входа, инициализация FreeRTOS и CAN
│   ├── can_min.c           # Логика инициализации и проверки CAN2
│   ├── system_clock.c      # Настройка PLL (SYSCLK = 168 MHz, APB1 = 42 MHz)
│   ├── freertos_hooks.c    # Системные хуки RTOS (Tick, Idle)
│   └── tasks.c             # Определение задач (TX/RX)
├── include/
│   ├── main.h
│   ├── can_min.h
│   └── freertos_hooks.h
├── platformio.ini          # Конфигурация сборки для PlatformIO
└── README.md               # Этот файл

---

## 🔌 Аппаратная конфигурация

Используется **CAN2** на плате STM32F4DISCOVERY:  
- **CAN2_TX** — PB13  
- **CAN2_RX** — PB12  

> На Discovery-плате **CAN1 (PA11/PA12)** не выведен на пины,  
> поэтому используется **CAN2**, который разделяет фильтры с CAN1.  

**Питание:**  
через встроенный **miniUSB (ST-Link)**.  
Терминационные резисторы **120 Ω не требуются** в loopback-режиме.

---

## ⏱ Настройки тактирования (SystemClock_Config)

| Параметр | Значение |
|-----------|-----------|
| HSE       | 8 MHz |
| PLL       | ×336 / ÷2 |
| SYSCLK    | 168 MHz |
| AHB       | 168 MHz |
| APB1      | 42 MHz *(CAN использует эту шину)* |
| APB2      | 84 MHz |

---

## 🧩 Конфигурация CAN2

| Параметр | Значение |
|-----------|-----------|
| Mode | `CAN_MODE_LOOPBACK` |
| Prescaler | 6 |
| TimeSeg1 | 11 TQ |
| TimeSeg2 | 2 TQ |
| SJW | 1 TQ |
| Bitrate | ≈ 500 кбит/с |
| AutoBusOff | DISABLE |
| AutoRetransmission | ENABLE |
| AutoWakeUp | DISABLE |
| ReceiveFifoLocked | DISABLE |

**Фильтр:** «принять всё» (`ID/MASK = 0x0000`),  
активирован на **CAN2 (FilterBank ≥ 14)**.

---

## 🧵 FreeRTOS

Используется базовая конфигурация:

- **Tick Rate:** 1 мс  
- **Heap:** `heap_4.c`  
- **Задачи:**  
  - `CanPingTask` — периодически отправляет CAN-фрейм и проверяет ответ.  
  - `LEDTask` — мигает при успешной передаче.  
  - **Хуки:** `vApplicationTickHook()` вызывает `HAL_IncTick()`.

---

## 💡 Индикация (LED)

| Светодиод | Цвет | Назначение |
|------------|------|------------|
| PD12 | Зелёный | Loopback успешен (приём кадра) |
| PD13 | Оранжевый | Передача кадра |
| PD14 | Красный | Ошибка инициализации или `HAL_ERROR` |
| PD15 | Синий | Резерв (не используется) |

---

## ▶️ Порядок запуска

1. Подключите **STM32F4DISCOVERY** по USB (miniUSB ST-Link).  
2. Откройте проект в **PlatformIO** → выберите среду `disco_f407vg`.  
3. Нажмите **Build → Upload**.  
4. После прошивки:
   - Если **PD14 мигает** → ошибка старта CAN (INAK не сброшен, проверьте GPIO).  
   - Если **PD13/PD12 мигают попеременно** → loopback работает.

---

## 🧠 Возможные проблемы и решения

| Симптом | Возможная причина | Решение |
|----------|------------------|----------|
| Постоянно мигает PD14 | RX не подтянут, CAN2 не стартует | Добавить `GPIO_PULLUP` на PB12 |
| Зависает при старте | Неправильный порядок `__HAL_RCC_CAN1/2_CLK_ENABLE` | Включать оба CAN перед конфигурацией |
| Ошибка `HAL_CAN_Start()` | CAN остался в INIT (INAK=1) | Проверить `CLEAR_BIT(MCR, CAN_MCR_INRQ)` |
| PD12/PD13 не мигают | FreeRTOS-задачи не запущены | Проверить `vTaskStartScheduler()` и стек задачи |

---

## 📚 Lessons Learned

- **CAN2 зависит от CAN1**, т.к. они делят общий фильтрный блок.  
- **Pull-up на RX обязателен**, иначе модуль не выйдет из INIT.  
- Биты **INAK/SLAK** требуют корректного сброса с задержкой (`vTaskDelay`).  
- **HAL_Delay()** нельзя использовать в RTOS — заменён на `vTaskDelay()`.  
- Чтобы периферия не "замораживалась" при паузе отладчика:
  ```c
  DBGMCU->APB1FZ &= ~(DBGMCU_APB1_FZ_DBG_CAN1_STOP | DBGMCU_APB1_FZ_DBG_CAN2_STOP);

## 🎥 Скриншоты и видео

---

- [Видео](https://youtu.be/1dAjeUZBr4c)
